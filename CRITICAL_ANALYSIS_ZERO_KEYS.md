#!/usr/bin/env python3
"""
CRITICAL FINDING: /keys Shows 0 Keys Analysis

Based on user report #3694128906:
- Telegram /keys output shows: "✅ Avec clé publique: 0"
- This means nodes_with_keys_count == 0
- 157 nodes in traffic, ALL reported as "sans clés"
"""

print("="*70)
print("CRITICAL ANALYSIS: Why /keys Shows 0 Keys")
print("="*70)
print()

print("USER REPORT:")
print("-----------")
print("Telegram /keys output:")
print("  Nœuds actifs: 157")
print("  ✅ Avec clé publique: 0")
print("  ❌ Sans clé publique: 157")
print()
print("Periodic sync logs (1 hour earlier):")
print("  Processing CHATO PCS1... Key already present and matches")
print("  Processing Kat Mobile... Key already present and matches")
print("  (and ~13 more nodes)")
print()

print("="*70)
print("ROOT CAUSE ANALYSIS:")
print("="*70)
print()

print("HYPOTHESIS #1: interface.nodes is EMPTY when /keys runs")
print("----------------------------------------------------------")
print("Evidence:")
print("  • Periodic sync finds ~13 nodes with keys in interface.nodes")
print("  • But /keys finds 0 nodes with keys")
print("  • This suggests interface.nodes has 0 entries when /keys runs")
print()
print("Possible causes:")
print("  A) TCP mode: interface.nodes not populated by Meshtastic library")
print("  B) interface.nodes gets cleared after periodic sync")
print("  C) Different interface objects (Telegram vs main bot)")
print()

print("HYPOTHESIS #2: Keys exist but are inaccessible")
print("-----------------------------------------------")
print("Evidence:")
print("  • Periodic sync finds keys: existing_key = user_info.get('public_key')")
print("  • /keys checks same: public_key = user_info.get('public_key') or user_info.get('publicKey')")
print("  • Same code path, same field names")
print()
print("Possible causes:")
print("  • user_info is not a dict (unlikely - sync would fail too)")
print("  • Key field has different name (unlikely - checked both)")
print("  • Key is empty string instead of None (would still be truthy)")
print()

print("HYPOTHESIS #3: Most likely - TCP mode issue")
print("--------------------------------------------")
print("In TCP mode:")
print("  • Bot connects to remote Meshtastic node via TCP")
print("  • interface.nodes might not be populated by Meshtastic library")
print("  • Periodic sync tries to inject keys into empty interface.nodes")
print("  • Sync creates entries: nodes[node_id] = {...}")
print("  • BUT: nodes is a local reference, not interface.nodes")
print()
print("The bug:")
print("  Line 644: nodes = getattr(interface, 'nodes', {})")
print("  This gets a REFERENCE to interface.nodes")
print("  Modifications to nodes SHOULD affect interface.nodes")
print("  BUT: If interface.nodes doesn't exist, getattr returns NEW dict {}")
print("  Modifications to this new dict don't affect interface!")
print()

print("="*70)
print("THE SMOKING GUN:")
print("="*70)
print()

print("Check line 644 in node_manager.py:")
print()
print("  nodes = getattr(interface, 'nodes', {})")
print()
print("If interface.nodes doesn't EXIST (TCP mode), getattr returns a NEW dict.")
print("All modifications go to this new dict, NOT to interface.nodes.")
print()
print("Then /keys does:")
print("  nodes = getattr(self.interface, 'nodes', {})")
print()
print("If interface.nodes still doesn't exist, it gets ANOTHER new dict (empty).")
print("Result: /keys sees empty dict, reports 0 keys.")
print()

print("="*70)
print("THE FIX:")
print("="*70)
print()

print("Instead of:")
print("  nodes = getattr(interface, 'nodes', {})")
print("  nodes[node_id]['user']['publicKey'] = key")
print()
print("Do:")
print("  if not hasattr(interface, 'nodes'):")
print("      interface.nodes = {}")
print("  nodes = interface.nodes")
print("  nodes[node_id]['user']['publicKey'] = key")
print()
print("This CREATES interface.nodes if it doesn't exist,")
print("then gets a reference to it (not a new dict).")
print()

print("="*70)
print("VERIFICATION:")
print("="*70)
print()

print("With DEBUG_MODE=True, check these logs:")
print()
print("1. During periodic sync:")
print("   • Does it say 'interface.nodes has 0 entries'?")
print("   • Or 'interface.nodes has 50+ entries'?")
print()
print("2. When /keys runs:")
print("   • Does it say 'interface.nodes has 0 entries'?")
print("   • Or does it show some entries?")
print()
print("If BOTH show 0 entries → TCP mode doesn't populate interface.nodes")
print("If sync shows 50+ but /keys shows 0 → interface.nodes gets cleared")
print()

print("="*70)
print("IMMEDIATE ACTION:")
print("="*70)
print()

print("1. User should enable DEBUG_MODE=True and share logs")
print("2. We'll see if interface.nodes is empty or populated")
print("3. Based on that, we'll implement the fix")
print()

print("Most likely fix needed:")
print("  • Ensure interface.nodes exists before syncing")
print("  • Create it if needed (TCP mode)")
print("  • Don't rely on default dict from getattr")
print()

print("="*70)
