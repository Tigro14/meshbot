<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Réseau Meshtastic - Paris IDF (vu par mon node)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overflow: hidden; }
        #map { width: 100%; height: 100vh; }
        
        .stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            width: 280px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .stats-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .stats-icon {
            width: 48px;
            height: 48px;
            margin-right: 12px;
        }
        
        .stats-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1a73e8;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .stat-label {
            font-weight: 500;
            color: #5f6368;
        }
        
        .stat-value {
            font-weight: 600;
            color: #202124;
        }
        
        .time-filters {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 8px;
            z-index: 1000;
        }
        
        .time-filter {
            background: rgba(255, 255, 255, 0.85);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.2s;
        }
        
        .time-filter:hover {
            background: rgba(255, 255, 255, 0.95);
        }
        
        .time-filter.active {
            background: #1a73e8;
            color: white;
        }
        
        .legend {
            background: rgba(255, 255, 255, 0.85);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }
        
        .legend h4 {
            margin-bottom: 8px;
            font-weight: 600;
            color: #202124;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .color-box {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid rgba(0, 0, 0, 0.2);
        }
        
        .owner-node {
            background-color: #1a73e8;
        }
        
        .popup-content {
            min-width: 250px;
            font-size: 0.95rem;
        }
        
        .popup-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .popup-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .owner-badge {
            background-color: #1a73e8;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8px;
        }
        
        tr {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        td {
            padding: 4px 0;
        }
        
        .label {
            font-weight: 500;
            color: #5f6368;
            padding-right: 10px;
        }
        
        .value {
            font-weight: 400;
            color: #202124;
            text-align: right;
        }
        
        .last-heard {
            font-size: 0.85rem;
            color: #5f6368;
            font-style: italic;
            margin-top: 6px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="stats">
        <div class="stats-header">
            <svg class="stats-icon" viewBox="0 0 24 24" fill="#1a73e8">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-15v6h6v-2h-4V5z"/>
            </svg>
            <div class="stats-title">Réseau Meshtastic</div>
        </div>
        <div class="stat-row">
            <span class="stat-label">Votre nœud:</span>
            <span id="owner" class="stat-value">Chargement...</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Nœuds totaux:</span>
            <span id="totalNodes" class="stat-value">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Nœuds visibles:</span>
            <span id="visibleNodes" class="stat-value">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Dernière MAJ:</span>
            <span id="lastUpdate" class="stat-value">--:--:--</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Dernier contact:</span>
            <span id="lastHeard" class="stat-value">--</span>
        </div>
    </div>

    <div class="time-filters">
        <button class="time-filter active" data-hours="4">4 heures</button>
        <button class="time-filter" data-hours="24">24 heures</button>
        <button class="time-filter" data-hours="168">7 jours</button>
        <button class="time-filter" data-hours="720">30 jours</button>
        <button class="time-filter" data-hours="all">Tout</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        // Configuration
        const CONFIG = {
            dataUrl: 'https://tigro.fr/info.json',
            myNodeId: '!a2e175ac',
            defaultZoom: 12,
            maxAgeDays: 30,
            ownerNodes: ['!a2e175ac']
        };
        
        // Variables globales
        let map;
        let markers = {};
        let currentFilterHours = 4;
        let meshData = null;
        
        async function loadMeshData() {
            try {
                const response = await fetch(CONFIG.dataUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                
                const text = await response.text();
                console.log('Contenu brut reçu (premiers 500 caractères):', text.substring(0, 500));
                
                // Trouver le début des nœuds (chercher le premier nœud connu)
                const nodesStart = text.indexOf('"!a2e175ac"');
                if (nodesStart === -1) {
                    throw new Error('Format de données invalide: impossible de trouver le nœud de départ');
                }
                
                // Trouver la fin de la section des nœuds
                const nodesEnd = text.indexOf('\n}\n\nPreferences:');
                if (nodesEnd === -1) {
                    throw new Error('Format de données invalide: impossible de trouver la fin des nœuds');
                }
                
                // Extraire uniquement la section JSON des nœuds
                const nodesJson = '{' + text.substring(nodesStart, nodesEnd) + '\n}';
                console.log('JSON extrait (premiers 500 caractères):', nodesJson.substring(0, 500));
                
                const parsedData = JSON.parse(nodesJson);
                console.log('Données parsées:', parsedData);
                
                return { nodes: parsedData };
                
            } catch (error) {
                console.error('Erreur de chargement:', error);
                throw error;
            }
        }
        
        function isValidPosition(position) {
            return position && 
                   typeof position.latitude === 'number' && 
                   typeof position.longitude === 'number' &&
                   !isNaN(position.latitude) && 
                   !isNaN(position.longitude) &&
                   position.latitude !== 0 && 
                   position.longitude !== 0 &&
                   Math.abs(position.latitude) <= 90 && 
                   Math.abs(position.longitude) <= 180;
        }
        
        function getNodeColor(lastHeard) {
            if (!lastHeard) return '#6c757d'; // Gris si pas de lastHeard
            
            const now = Math.floor(Date.now() / 1000);
            const hoursAgo = (now - lastHeard) / 3600;
            
            if (hoursAgo <= 4) return '#28a745';    // Vert - Moins de 4h
            if (hoursAgo <= 24) return '#ffc107';   // Jaune - Moins de 24h
            if (hoursAgo <= 168) return '#fd7e14';  // Orange - Moins de 7 jours
            return '#dc3545';                       // Rouge - Plus de 7 jours
        }
        
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days} jour${days > 1 ? 's' : ''}`;
            if (hours > 0) return `${hours} heure${hours > 1 ? 's' : ''}`;
            return `${Math.floor(seconds / 60)} minutes`;
        }
        
        async function initMap() {
            try {
                // Charger les données
                meshData = await loadMeshData();
                console.log('Données mesh chargées:', meshData);
                
                // Trouver le nœud principal pour centrer la carte
                const myNode = meshData.nodes[CONFIG.myNodeId];
                
                if (!myNode?.position || !isValidPosition(myNode.position)) {
                    throw new Error('Position du nœud principal introuvable ou invalide');
                }
                
                // Initialiser la carte centrée sur votre nœud
                map = L.map('map').setView(
                    [myNode.position.latitude, myNode.position.longitude],
                    CONFIG.defaultZoom
                );
                
                // Ajouter la couche de tuiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                
                // Créer les marqueurs
                createMarkers(meshData.nodes);
                
                // Mettre à jour les statistiques
                const nodesWithPosition = Object.values(meshData.nodes).filter(n => isValidPosition(n.position)).length;
                document.getElementById('totalNodes').textContent = `${nodesWithPosition} (${Object.keys(meshData.nodes).length} total)`;
                document.getElementById('owner').textContent = myNode.user?.longName || 'Inconnu';
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('fr-FR');
                
                // Ajouter la légende
                const legend = L.control({ position: 'bottomleft' });
                legend.onAdd = () => {
                    const div = L.DomUtil.create('div', 'legend');
                    div.innerHTML = `
                        <h4>Légende</h4>
                        <div class="legend-item">
                            <div class="color-box" style="background-color:#28a745"></div>
                            <span>&lt; 4 heures</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box" style="background-color:#ffc107"></div>
                            <span>&lt; 24 heures</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box" style="background-color:#fd7e14"></div>
                            <span>&lt; 7 jours</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box" style="background-color:#dc3545"></div>
                            <span>&gt; 7 jours</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box" style="background-color:#6c757d"></div>
                            <span>Date inconnue</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box owner-node"></div>
                            <span>Votre nœud</span>
                        </div>
                    `;
                    return div;
                };
                legend.addTo(map);
                
                // Gestion des filtres temporels
                document.querySelectorAll('.time-filter').forEach(button => {
                    button.addEventListener('click', function() {
                        document.querySelectorAll('.time-filter').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        this.classList.add('active');
                        currentFilterHours = this.dataset.hours === 'all' ? null : parseInt(this.dataset.hours);
                        applyTimeFilter();
                    });
                });
                
            } catch (error) {
                console.error('Erreur initialisation carte:', error);
                alert('Erreur de chargement des données: ' + error.message);
            }
        }
        
        function createMarkers(data) {
            // Supprimer les marqueurs existants
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            markers = {};
            
            const now = Math.floor(Date.now() / 1000);
            let visibleCount = 0;
            let lastHeardNode = null;
            let lastHeardTime = 0;
            
            Object.entries(data).forEach(([id, node]) => {
                // Validation stricte de la position
                if (!isValidPosition(node.position)) {
                    console.log(`Nœud ${id} ignoré: position invalide`, node.position);
                    return;
                }
                
                const isOwner = CONFIG.ownerNodes.includes(id);
                const lastHeard = node.lastHeard || 0;
                const hoursAgo = lastHeard ? (now - lastHeard) / 3600 : Infinity;
                
                // Détection du nœud le plus récent
                if (lastHeard > lastHeardTime) {
                    lastHeardTime = lastHeard;
                    lastHeardNode = node;
                }
                
                // Filtrage temporel (sauf pour le filtre "Tout")
                if (currentFilterHours !== null && lastHeard > 0 && hoursAgo > currentFilterHours) {
                    return;
                }
                
                // Pour le filtre "Tout", afficher aussi les nœuds sans lastHeard
                
                try {
                    // Création du marqueur avec validation
                    const marker = L.circleMarker(
                        [node.position.latitude, node.position.longitude],
                        {
                            radius: isOwner ? 16 : 12,
                            className: `node-marker ${isOwner ? 'node-marker-owner' : ''}`,
                            fillColor: isOwner ? '#1a73e8' : getNodeColor(lastHeard),
                            color: '#ffffff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.9
                        }
                    );
                    
                    // Interaction au survol (sans animation de déplacement)
                    marker.on('mouseover', function() {
                        this.setStyle({ fillOpacity: 1 });
                    }).on('mouseout', function() {
                        this.setStyle({ fillOpacity: 0.9 });
                    });
                    
                    // Construction du contenu de l'infobulle
                    const lastHeardDate = lastHeard ? new Date(lastHeard * 1000) : null;
                    const lastHeardStr = lastHeardDate ? lastHeardDate.toLocaleString('fr-FR') : 'Jamais';
                    const timeAgo = lastHeard ? formatDuration(now - lastHeard) : 'inconnu';
                    
                    const popupContent = `
                        <div class="popup-content">
                            <div class="popup-header">
                                <h3>${node.user?.longName || id}</h3>
                                ${isOwner ? '<div class="owner-badge">Votre nœud</div>' : ''}
                            </div>
                            <table>
                                <tr>
                                    <td class="label">ID:</td>
                                    <td class="value">${id}</td>
                                </tr>
                                <tr>
                                    <td class="label">Position:</td>
                                    <td class="value">${node.position.latitude.toFixed(5)}, ${node.position.longitude.toFixed(5)}</td>
                                </tr>
                                <tr>
                                    <td class="label">Altitude:</td>
                                    <td class="value">${node.position.altitude ? Math.round(node.position.altitude) + 'm' : 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td class="label">SNR:</td>
                                    <td class="value">${node.snr || 'N/A'}</td>
                                </tr>
                            </table>
                            <div class="last-heard">Dernier contact: ${lastHeardStr}${lastHeard ? ` (il y a ${timeAgo})` : ''}</div>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    marker.addTo(map);
                    markers[id] = marker;
                    visibleCount++;
                } catch (error) {
                    console.error(`Erreur création marqueur pour ${id}:`, error, node);
                }
            });
            
            // Mise à jour des statistiques
            document.getElementById('visibleNodes').textContent = visibleCount;
            if (lastHeardNode) {
                const lastHeardDate = new Date(lastHeardTime * 1000);
                document.getElementById('lastHeard').textContent = 
                    `${lastHeardNode.user?.longName || 'Nœud'} à ${lastHeardDate.toLocaleTimeString('fr-FR')}`;
            }
        }
        
        function applyTimeFilter() {
            if (meshData) {
                createMarkers(meshData.nodes);
            }
        }
        
        // Démarrer l'initialisation
        initMap();
    </script>
</body>
</html>

