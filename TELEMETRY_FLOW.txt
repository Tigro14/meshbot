â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ESPHOME TELEMETRY BROADCAST FLOW                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          INITIALIZATION                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    config.py
    â”œâ”€â”€ ESPHOME_TELEMETRY_ENABLED = True
    â””â”€â”€ ESPHOME_TELEMETRY_INTERVAL = 3600  # 1 hour

    main_bot.py::__init__()
    â””â”€â”€ self._last_telemetry_broadcast = 0

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PERIODIC TIMER (Every 5 min)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    periodic_update_thread()
    â”‚
    â”œâ”€â”€ Sleep: NODE_UPDATE_INTERVAL (300s)
    â”‚
    â”œâ”€â”€ Update node database
    â”œâ”€â”€ Cleanup old data
    â”œâ”€â”€ Save statistics
    â”‚
    â””â”€â”€ â° TELEMETRY CHECK
        â”‚
        â”œâ”€â”€ Is ESPHOME_TELEMETRY_ENABLED? â”€â”€â†’ No â”€â”€â†’ Skip
        â”‚                                   â”‚
        â”‚                                   â””â†’ Yes
        â”‚
        â”œâ”€â”€ Time since last broadcast? â”€â”€â†’ < 3600s â”€â”€â†’ Skip
        â”‚                                â”‚
        â”‚                                â””â†’ >= 3600s
        â”‚
        â””â”€â”€ âœ… Call send_esphome_telemetry()

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TELEMETRY BROADCAST PROCESS                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    send_esphome_telemetry()
    â”‚
    â”œâ”€â”€ 1ï¸âƒ£ Fetch Sensor Data
    â”‚   â”‚
    â”‚   â””â”€â”€ esphome_client.get_sensor_values()
    â”‚       â”‚
    â”‚       â”œâ”€â”€ HTTP: GET /sensor/bme280_temperature â”€â”€â†’ 21.5Â°C
    â”‚       â”œâ”€â”€ HTTP: GET /sensor/bme280_pressure â”€â”€â”€â”€â†’ 1013.25 hPa
    â”‚       â”œâ”€â”€ HTTP: GET /sensor/bme280_humidity â”€â”€â”€â”€â†’ 56.4%
    â”‚       â””â”€â”€ HTTP: GET /sensor/battery_voltage â”€â”€â”€â”€â†’ 12.8V
    â”‚       â”‚
    â”‚       â””â”€â”€ Return: {
    â”‚               'temperature': 21.5,
    â”‚               'pressure': 101325.0,  # Auto-converted to Pa
    â”‚               'humidity': 56.4,
    â”‚               'battery_voltage': 12.8
    â”‚           }
    â”‚
    â”œâ”€â”€ 2ï¸âƒ£ Create PACKET 1: Environment Metrics
    â”‚   â”‚   âš ï¸  Meshtastic telemetry uses 'oneof' - only ONE metric type per packet!
    â”‚   â”‚
    â”‚   â””â”€â”€ env_telemetry = telemetry_pb2.Telemetry()
    â”‚       â”‚
    â”‚       â”œâ”€â”€ time = 1700000000
    â”‚       â”‚
    â”‚       â””â”€â”€ environment_metrics
    â”‚           â”œâ”€â”€ temperature = 21.5
    â”‚           â”œâ”€â”€ barometric_pressure = 101325.0
    â”‚           â””â”€â”€ relative_humidity = 56.4
    â”‚
    â”œâ”€â”€ 3ï¸âƒ£ Broadcast PACKET 1 to Mesh
    â”‚   â”‚
    â”‚   â””â”€â”€ interface.sendData(
    â”‚           env_telemetry,
    â”‚           destinationId = 0xFFFFFFFF,  # All nodes
    â”‚           portNum = TELEMETRY_APP,
    â”‚           wantResponse = False
    â”‚       )
    â”‚
    â”œâ”€â”€ ğŸ• Small delay (0.5s) between packets
    â”‚
    â”œâ”€â”€ 4ï¸âƒ£ Create PACKET 2: Device Metrics
    â”‚   â”‚
    â”‚   â””â”€â”€ device_telemetry = telemetry_pb2.Telemetry()
    â”‚       â”‚
    â”‚       â”œâ”€â”€ time = 1700000000
    â”‚       â”‚
    â”‚       â””â”€â”€ device_metrics
    â”‚           â”œâ”€â”€ voltage = 12.8
    â”‚           â””â”€â”€ battery_level = 64  # Calculated from voltage
    â”‚
    â””â”€â”€ 5ï¸âƒ£ Broadcast PACKET 2 to Mesh
        â”‚
        â””â”€â”€ interface.sendData(
                device_telemetry,
                destinationId = 0xFFFFFFFF,  # All nodes
                portNum = TELEMETRY_APP,
                wantResponse = False
            )

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         NETWORK PROPAGATION                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Bot Node (tigrobot)
         â”‚
         â”‚ ğŸ“¡ TELEMETRY_APP broadcast (PACKET 1: environment)
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚              â”‚              â”‚
         â–¼              â–¼              â–¼              â–¼
    Node A         Node B         Node C         Node D
    (tigrog2)     (User 1)       (User 2)      (Router)
         â”‚              â”‚              â”‚              â”‚
         â””â”€â”€ All nodes receive environment_metrics
    
    (0.5s delay)
    
    Bot Node (tigrobot)
         â”‚
         â”‚ ğŸ“¡ TELEMETRY_APP broadcast (PACKET 2: device)
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚              â”‚              â”‚
         â–¼              â–¼              â–¼              â–¼
    Node A         Node B         Node C         Node D
    (tigrog2)     (User 1)       (User 2)      (Router)
         â”‚              â”‚              â”‚              â”‚
         â””â”€â”€ All nodes receive device_metrics and can display complete telemetry

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         RECEIVING NODES                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Meshtastic Apps (iOS/Android/Web)
    â”‚
    â”œâ”€â”€ Node Details â†’ Telemetry Tab
    â”‚   â”‚
    â”‚   â”œâ”€â”€ ğŸŒ¡ï¸ Temperature: 21.5Â°C
    â”‚   â”œâ”€â”€ ğŸ”½ Pressure: 1013.25 hPa
    â”‚   â”œâ”€â”€ ğŸ’§ Humidity: 56.4%
    â”‚   â””â”€â”€ ğŸ”‹ Battery: 12.8V (64%)
    â”‚
    â””â”€â”€ Can plot graphs, set alerts, etc.

    Python API
    â”‚
    â””â”€â”€ pub.subscribe(on_telemetry, "meshtastic.receive.telemetry")
        â”‚
        â””â”€â”€ def on_telemetry(packet, interface):
                decoded = packet['decoded']
                telemetry = decoded['telemetry']
                env = telemetry['environmentMetrics']
                print(f"Temp: {env['temperature']}Â°C")

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ERROR HANDLING                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Scenario 1: ESPHome Offline
    â”‚
    â””â”€â”€ get_sensor_values() â”€â”€â†’ Returns None
        â”‚
        â””â”€â”€ send_esphome_telemetry() â”€â”€â†’ Logs warning, no broadcast

    Scenario 2: Some Sensors Missing
    â”‚
    â””â”€â”€ get_sensor_values() â”€â”€â†’ Returns partial data
        â”‚                         {'temperature': 21.5,
        â”‚                          'pressure': None,
        â”‚                          'humidity': None,
        â”‚                          'battery_voltage': 12.8}
        â”‚
        â””â”€â”€ send_esphome_telemetry() â”€â”€â†’ Broadcasts 2 packets (env + device)
                                          Packet 1: temperature only
                                          Packet 2: battery voltage + level

    Scenario 3: All Sensors Missing (but ESPHome online)
    â”‚
    â””â”€â”€ get_sensor_values() â”€â”€â†’ Returns None (all values None)
        â”‚
        â””â”€â”€ send_esphome_telemetry() â”€â”€â†’ Logs warning, no broadcast

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CONFIGURATION                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    To Enable (default):
        ESPHOME_TELEMETRY_ENABLED = True
        ESPHOME_TELEMETRY_INTERVAL = 3600  # Every hour

    To Change Frequency:
        ESPHOME_TELEMETRY_INTERVAL = 1800  # Every 30 minutes
        ESPHOME_TELEMETRY_INTERVAL = 7200  # Every 2 hours

    To Disable:
        ESPHOME_TELEMETRY_ENABLED = False

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PERFORMANCE METRICS                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Network Impact:
        â€¢ 2 packets per hour (default) - ONE for env, ONE for device
        â€¢ ~50-100 bytes per packet
        â€¢ Broadcast (single transmission each)
        â€¢ 0.5s delay between packets to avoid mesh congestion

    Memory Impact:
        â€¢ Temporary allocation: ~1KB total
        â€¢ Immediately garbage collected
        â€¢ No persistent storage

    CPU Impact:
        â€¢ HTTP requests: ~100ms total
        â€¢ Protobuf creation: <1ms per packet
        â€¢ Runs in existing thread

    Total Overhead:
        â€¢ Negligible (<0.1% CPU)
        â€¢ No memory accumulation
        â€¢ Minimal network usage

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                              END OF FLOW                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
