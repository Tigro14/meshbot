<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte Réseau Meshtastic - Paris IDF vu par tigro G2 PV</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overflow: hidden; }
        #map { width: 100%; height: 100vh; }
        
        .stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            width: 280px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .stats-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .stats-icon {
            width: 48px;
            height: 48px;
            margin-right: 12px;
        }
        
        .stats-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1a73e8;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .stat-label {
            font-weight: 500;
            color: #5f6368;
        }
        
        .stat-value {
            font-weight: 600;
            color: #1a73e8;
        }
        
        .view-buttons {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .view-btn {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #dadce0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            color: #5f6368;
        }
        
        .view-btn:hover {
            background: #f8f9fa;
            border-color: #1a73e8;
        }
        
        .view-btn.active {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }
        
        .filter-btn {
            flex: 1;
            min-width: 60px;
            padding: 6px 10px;
            border: 1px solid #dadce0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            color: #5f6368;
        }
        
        .filter-btn:hover {
            background: #f8f9fa;
            border-color: #1a73e8;
        }
        
        .filter-btn.active {
            background: #1a73e8;
            color: white;
            border-color: #1a73e8;
        }
        
        .legend {
            background: rgba(255, 255, 255, 0.85);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .legend h4 {
            margin: 0 0 8px 0;
            color: #202124;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
            font-size: 0.85rem;
        }
        
        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .legend-line {
            width: 30px;
            height: 3px;
            margin-right: 8px;
        }
        
        .owner-node {
            background-color: #e74c3c;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .leaflet-popup-content {
            margin: 12px;
            font-size: 0.9rem;
        }
        
        .popup-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: #1a73e8;
            margin-bottom: 8px;
        }
        
        .popup-info {
            color: #5f6368;
            line-height: 1.6;
        }
        
        .popup-info strong {
            color: #202124;
        }
        
        .node-label {
            font-size: 10px;
            font-weight: bold;
            color: #000;
            text-shadow: 0 0 3px #fff, 0 0 3px #fff, 0 0 3px #fff;
            white-space: nowrap;
            pointer-events: none;
            text-align: center;
            position: relative;
            top: -20px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="stats">
        <div class="stats-header">
            <svg class="stats-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" stroke="#1a73e8" stroke-width="2"/>
                <path d="M12 6v6l4 2" stroke="#1a73e8" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <div class="stats-title">Réseau Mesh vu par tigro G2 PV</div>
        </div>
        
        <div class="view-buttons">
            <button class="view-btn active" onclick="setView('nodes')">Nœuds</button>
            <button class="view-btn" onclick="setView('links')">Liens</button>
            <button class="view-btn" onclick="setView('both')">Les deux</button>
        </div>
        
        <div class="stat-row">
            <span class="stat-label">Nœuds actifs</span>
            <span class="stat-value" id="visibleNodes">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Total nœuds</span>
            <span class="stat-value" id="totalNodes">0</span>
        </div>
        <div class="stat-row" id="linksRow" style="display: none;">
            <span class="stat-label">Liaisons</span>
            <span class="stat-value" id="totalLinks">0</span>
        </div>
        <div class="stat-row" style="border-bottom: none;">
            <span class="stat-label">Dernier entendu</span>
        </div>
        <div style="font-size: 0.85rem; color: #5f6368; margin-top: 4px;" id="lastHeard">
            Chargement...
        </div>
        
        <div class="filter-buttons">
            <button class="filter-btn" onclick="setTimeFilter('all')">Tout</button>
            <button class="filter-btn active" onclick="setTimeFilter('24')">24h</button>
            <button class="filter-btn" onclick="setTimeFilter('48')">48h</button>
            <button class="filter-btn" onclick="setTimeFilter('72')">72h</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        let map;
        let markers = {};
        let labelMarkers = {};
        let meshData = null;
        let currentFilter = '24';
        let currentView = 'nodes';
        let myNodeId = '!a2e175ac';
        let linkLayerGroup = L.layerGroup();
        let linkCount = 0;
        
        function isValidPosition(lat, lon) {
            return lat !== undefined && lon !== undefined && 
                   lat !== null && lon !== null &&
                   lat !== 0 && lon !== 0 &&
                   !isNaN(lat) && !isNaN(lon) &&
                   lat >= -90 && lat <= 90 &&
                   lon >= -180 && lon <= 180;
        }
        
        function getNodeColorByHop(hopsAway) {
            if (hopsAway === undefined || hopsAway === null) {
                return '#95a5a6'; // Gris (4+ sauts)
            }

            switch(hopsAway) {
                case 0: return '#27ae60'; // Vert (direct)
                case 1: return '#3498db'; // Bleu (1 saut)
                case 2: return '#f39c12'; // Jaune (2 sauts)
                case 3: return '#e67e22'; // Orange (3 sauts)
                case 4: return '#9b59b6'; // Violet (4 sauts)
                default: return '#95a5a6'; // Gris (5+ sauts)
            }
        }
        
        function getLinkColor(snr) {
            if (snr === null || snr === undefined) return '#888888';
            if (snr > 5) return '#00ff00'; // Vert - Excellent
            if (snr > 0) return '#ffff00';  // Jaune - Bon
            return '#ff6600';                // Orange - Faible
        }

        function getLinkOpacity(snr) {
            if (snr === null || snr === undefined) return 0.3;
            if (snr > 5) return 0.9;
            if (snr > 0) return 0.6;
            return 0.4;
        }

        function getLinkWeight(snr) {
            if (snr === null || snr === undefined) return 3;
            if (snr > 5) return 7;
            if (snr > 0) return 5;
            return 4;
        }
        
        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide links row in stats
            const linksRow = document.getElementById('linksRow');
            if (view === 'links' || view === 'both') {
                linksRow.style.display = 'flex';
            } else {
                linksRow.style.display = 'none';
            }
            
            updateMapView();
        }
        
        function setTimeFilter(hours) {
            currentFilter = hours;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            applyTimeFilter();
        }
        
        async function parseNodeInfo() {
            try {
                const response = await fetch('https://tigro.fr/info.json');
                const data = await response.json();
                
                console.log('✓ JSON chargé avec succès!');
                console.log('Nombre de nœuds:', Object.keys(data['Nodes in mesh']).length);
                
                return { nodes: data['Nodes in mesh'] };
            } catch (error) {
                console.error('ERREUR chargement JSON:', error);
                throw error;
            }
        }
        
        async function initMap() {
            map = L.map('map').setView([48.8566, 2.3522], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            const legend = L.control({position: 'bottomright'});
            
            legend.onAdd = () => {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <h4 id="legendTitle">Distance (hops)</h4>
                    <div id="hopsLegend">
                        <div class="legend-item">
                            <div class="color-box owner-node"></div>
                            <span>Votre nœud</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box" style="background-color:#27ae60"></div>
                            <span>Direct (0 hop)</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box" style="background-color:#3498db"></div>
                            <span>Hop 1</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box" style="background-color:#f39c12"></div>
                            <span>Hop 2</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box" style="background-color:#e67e22"></div>
                            <span>Hop 3</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box" style="background-color:#9b59b6"></div>
                            <span>Hop 4</span>
                        </div>
                        <div class="legend-item">
                            <div class="color-box" style="background-color:#95a5a6"></div>
                            <span>Hop 5+</span>
                        </div>
                    </div>
                    <div id="linksLegend" style="display:none;">
                        <div class="legend-item">
                            <div class="legend-line" style="background-color: #00ff00;"></div>
                            <span>Excellente (SNR > 5)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-line" style="background-color: #ffff00;"></div>
                            <span>Bonne (SNR 0-5)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-line" style="background-color: #ff6600;"></div>
                            <span>Faible (SNR < 0)</span>
                        </div>
                    </div>
                `;
                return div;
            };
            
            legend.addTo(map);
            
            try {
                meshData = await parseNodeInfo();
                
                document.getElementById('totalNodes').textContent = Object.keys(meshData.nodes).length;
                
                // Centrer la carte sur votre nœud si disponible
                if (meshData.nodes[myNodeId] && meshData.nodes[myNodeId].position) {
                    const myNode = meshData.nodes[myNodeId];
                    if (isValidPosition(myNode.position.latitude, myNode.position.longitude)) {
                        console.log('Centrage sur votre nœud:', myNode.position.latitude, myNode.position.longitude);
                        map.setView([myNode.position.latitude, myNode.position.longitude], 13);
                    }
                }
                
                createMarkers(meshData.nodes);
                updateMapView();
            } catch (error) {
                console.error('Erreur chargement données:', error);
                document.getElementById('lastHeard').textContent = 'Erreur: ' + error.message;
            }
        }
        
        function updateMapView() {
            // Update legend
            const hopsLegend = document.getElementById('hopsLegend');
            const linksLegend = document.getElementById('linksLegend');
            const legendTitle = document.getElementById('legendTitle');
            
            // Safety check - return if elements don't exist yet
            if (!hopsLegend || !linksLegend || !legendTitle || !map) {
                return;
            }
            
            if (currentView === 'nodes') {
                hopsLegend.style.display = 'block';
                linksLegend.style.display = 'none';
                legendTitle.textContent = 'Distance (hops)';
                if (map.hasLayer(linkLayerGroup)) {
                    map.removeLayer(linkLayerGroup);
                }
            } else if (currentView === 'links') {
                hopsLegend.style.display = 'none';
                linksLegend.style.display = 'block';
                legendTitle.textContent = 'Qualité des liaisons';
                if (!map.hasLayer(linkLayerGroup)) {
                    map.addLayer(linkLayerGroup);
                }
                if (meshData && meshData.nodes) {
                    drawLinks(meshData.nodes);
                }
            } else if (currentView === 'both') {
                hopsLegend.style.display = 'block';
                linksLegend.style.display = 'block';
                legendTitle.textContent = 'Distance et Liaisons';
                if (!map.hasLayer(linkLayerGroup)) {
                    map.addLayer(linkLayerGroup);
                }
                if (meshData && meshData.nodes) {
                    drawLinks(meshData.nodes);
                }
            }
        }
        
        function drawLinks(nodes) {
            linkLayerGroup.clearLayers();
            linkCount = 0;
            const drawnLinks = new Set();

            // Convertir en tableau si nécessaire
            const nodesArray = Array.isArray(nodes) ? nodes : Object.values(nodes);
            
            let hasNeighborInfo = false;
            
            nodesArray.forEach(node => {
                const nodeId = node.user?.id || node.nodeId;
                if (!node.position || !markers[nodeId]) return;

                const neighbors = node.neighbors || node.neighbours || [];
                
                if (neighbors.length > 0) {
                    hasNeighborInfo = true;
                    
                    neighbors.forEach(neighbor => {
                        const neighborId = neighbor.nodeId || neighbor.node_id || neighbor.id;
                        if (!markers[neighborId]) return;
                        
                        const linkKey = [nodeId, neighborId].sort().join('-');
                        if (drawnLinks.has(linkKey)) return;
                        drawnLinks.add(linkKey);

                        const fromLatLng = markers[nodeId].getLatLng();
                        const toLatLng = markers[neighborId].getLatLng();
                        const snr = neighbor.snr || neighbor.SNR || null;
                        
                        const line = L.polyline([fromLatLng, toLatLng], {
                            color: getLinkColor(snr),
                            weight: getLinkWeight(snr),
                            opacity: getLinkOpacity(snr),
                            dashArray: snr === null ? '5, 5' : null
                        });

                        let popupContent = `<strong>Liaison directe</strong><br>`;
                        popupContent += `${node.user.shortName || nodeId} ↔ ${markers[neighborId].options.title}<br>`;
                        if (snr !== null) popupContent += `SNR: ${snr.toFixed(1)} dB`;
                        
                        line.bindPopup(popupContent);
                        linkLayerGroup.addLayer(line);
                        linkCount++;
                    });
                }
            });

            // Si pas d'infos de voisinage, créer des liaisons inférées
            if (!hasNeighborInfo) {
                console.log('Pas d\'infos de voisinage - utilisation de liaisons inférées');
                
                nodesArray.forEach(node => {
                    const nodeId = node.user?.id || node.nodeId;
                    if (!node.position || !markers[nodeId]) return;
                    
                    if (node.hopsAway && node.hopsAway > 0) {
                        const targetHops = node.hopsAway - 1;
                        const potentialParents = nodesArray.filter(n => {
                            const nId = n.user?.id || n.nodeId;
                            return nId !== nodeId && 
                                   n.position && 
                                   markers[nId] && 
                                   (n.hopsAway === targetHops || (!n.hopsAway && targetHops === 0));
                        });
                        
                        if (potentialParents.length > 0) {
                            potentialParents.sort((a, b) => {
                                const snrA = a.snr || -100;
                                const snrB = b.snr || -100;
                                return snrB - snrA;
                            });
                            
                            const parent = potentialParents[0];
                            const parentId = parent.user?.id || parent.nodeId;
                            
                            const linkKey = [nodeId, parentId].sort().join('-');
                            if (!drawnLinks.has(linkKey)) {
                                drawnLinks.add(linkKey);
                                
                                const fromLatLng = markers[nodeId].getLatLng();
                                const toLatLng = markers[parentId].getLatLng();
                                
                                const line = L.polyline([fromLatLng, toLatLng], {
                                    color: getLinkColor(node.snr),
                                    weight: getLinkWeight(node.snr),
                                    opacity: getLinkOpacity(node.snr) * 0.6,
                                    dashArray: '5, 5'
                                });

                                let popupContent = `<strong>Liaison inférée</strong><br>`;
                                popupContent += `${node.user.shortName || nodeId} → ${parent.user.shortName || parentId}<br>`;
                                popupContent += `Distance: ${node.hopsAway} hop(s)<br>`;
                                if (node.snr) popupContent += `SNR: ${node.snr.toFixed(1)} dB`;
                                
                                line.bindPopup(popupContent);
                                linkLayerGroup.addLayer(line);
                                linkCount++;
                            }
                        }
                    }
                });
            }

            document.getElementById('totalLinks').textContent = linkCount;
        }
        
        function createMarkers(nodes) {
            console.log('=== DEBUT createMarkers ===');
            console.log('Nombre de nœuds à traiter:', Object.keys(nodes).length);
            
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            Object.values(labelMarkers).forEach(marker => map.removeLayer(marker));
            markers = {};
            labelMarkers = {};
            
            let visibleCount = 0;
            let lastHeardTime = 0;
            let lastHeardNode = null;
            
            const now = Date.now() / 1000;
            
            Object.entries(nodes).forEach(([id, node]) => {
                if (!isValidPosition(node.position?.latitude, node.position?.longitude)) {
                    return;
                }
                
                const lastHeard = node.lastHeard || 0;
                const hoursAgo = (now - lastHeard) / 3600;
                
                if (currentFilter !== 'all') {
                    const hours = parseInt(currentFilter);
                    if (hoursAgo > hours) {
                        return;
                    }
                }
                
                if (lastHeard > lastHeardTime) {
                    lastHeardTime = lastHeard;
                    lastHeardNode = node;
                }
                
                try {
                    const lat = node.position.latitude;
                    const lon = node.position.longitude;
                    
                    let color;
                    if (id === myNodeId) {
                        color = '#e74c3c';
                    } else {
                        color = getNodeColorByHop(node.hopsAway);
                    }
                    
                    const marker = L.circleMarker([lat, lon], {
                        radius: id === myNodeId ? 20 : 12,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8,
                        title: node.user?.shortName || id
                    });
                    
                    // Add tooltip with longName that shows on hover
                    const longName = node.user?.longName || 'Nœud inconnu';
                    marker.bindTooltip(longName, {
                        permanent: false,
                        direction: 'top',
                        className: 'node-tooltip'
                    });
                    
                    // Create a divIcon with text label for the 4 hex digits from node ID
                    // Extract last 4 hex digits from ID (e.g., "!16fad3dc" -> "d3dc")
                    const hexLabel = id.startsWith('!') ? id.substring(id.length - 4) : id.substring(0, 4);
                    const labelIcon = L.divIcon({
                        html: `<div class="node-label">${hexLabel}</div>`,
                        className: '',
                        iconSize: [null, null]
                    });
                    
                    const labelMarker = L.marker([lat, lon], {
                        icon: labelIcon,
                        interactive: false
                    });
                    labelMarker.addTo(map);
                    labelMarkers[id] = labelMarker;
                    
                    marker.on('mouseover', function() {
                        this.setStyle({ fillOpacity: 1 });
                    });
                    
                    marker.on('mouseout', function() {
                        this.setStyle({ fillOpacity: 0.8 });
                    });
                    
                    const lastHeardDate = new Date(lastHeard * 1000);
                    const hoursAgoText = hoursAgo < 1 ? 
                        `Il y a ${Math.floor(hoursAgo * 60)} minutes` : 
                        `Il y a ${Math.floor(hoursAgo)} heures`;
                    
                    let popupContent = `<div class="popup-title">${node.user?.longName || 'Nœud inconnu'}</div>`;
                    popupContent += `<div class="popup-info">`;
                    popupContent += `<strong>ID:</strong> ${node.user?.shortName || id}<br>`;
                    popupContent += `<strong>Hops:</strong> ${node.hopsAway !== undefined ? node.hopsAway : 'N/A'}<br>`;
                    popupContent += `<strong>SNR:</strong> ${node.snr !== undefined ? node.snr.toFixed(1) + ' dB' : 'N/A'}<br>`;
                    if (node.neighbors || node.neighbours) {
                        const neighborCount = (node.neighbors || node.neighbours).length;
                        popupContent += `<strong>Voisins directs:</strong> ${neighborCount}<br>`;
                    }
                    popupContent += `<strong>Dernier contact:</strong> ${lastHeardDate.toLocaleString('fr-FR')}<br>`;
                    popupContent += `<em>${hoursAgoText}</em>`;
                    popupContent += `</div>`;
                    
                    marker.bindPopup(popupContent);
                    marker.addTo(map);
                    markers[id] = marker;
                    visibleCount++;
                } catch (error) {
                    console.error(`Erreur création marqueur ${id}:`, error);
                }
            });
            
            console.log(`Total marqueurs créés: ${visibleCount}`);
            
            document.getElementById('visibleNodes').textContent = visibleCount;
            if (lastHeardNode) {
                const lastHeardDate = new Date(lastHeardTime * 1000);
                document.getElementById('lastHeard').textContent = 
                    `${lastHeardNode.user?.longName || 'Nœud'} à ${lastHeardDate.toLocaleTimeString('fr-FR')}`;
            }
        }
        
        function applyTimeFilter() {
            if (meshData) {
                createMarkers(meshData.nodes);
                updateMapView();
            }
        }
        
        // Check for URL parameters to set initial view
        function initFromURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const viewParam = urlParams.get('view');
            
            if (viewParam && ['nodes', 'links', 'both'].includes(viewParam)) {
                currentView = viewParam;
                
                // Update button states
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Activate the correct button based on viewParam
                const buttons = document.querySelectorAll('.view-btn');
                if (viewParam === 'nodes' && buttons[0]) {
                    buttons[0].classList.add('active');
                } else if (viewParam === 'links' && buttons[1]) {
                    buttons[1].classList.add('active');
                } else if (viewParam === 'both' && buttons[2]) {
                    buttons[2].classList.add('active');
                }
                
                // Show/hide links row
                const linksRow = document.getElementById('linksRow');
                if (linksRow && (viewParam === 'links' || viewParam === 'both')) {
                    linksRow.style.display = 'flex';
                }
            }
        }
        
        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initFromURLParams();
            initMap();
        });
    </script>
</body>
</html>
