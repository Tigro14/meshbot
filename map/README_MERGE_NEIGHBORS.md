# merge_neighbor_data.py - JSON Merge Tool for Map Visualization

## Purpose

This script merges neighbor relationship data from `info_neighbors.json` into the main `info.json` file, enabling complete map visualization with both node coloring and link drawing.

## Background

The map visualization requires two types of data:
1. **Node information** with `hopsAway` field (for color-coding nodes by distance)
2. **Neighbor relationships** with `neighbors` arrays (for drawing connection lines)

These are generated by separate scripts:
- `export_nodes_from_db.py` → generates `info.json` with node data + hopsAway
- `export_neighbors_from_db.py` → generates `info_neighbors.json` with neighbor relationships

However, `map.html` only loads `info.json`, so the neighbor data must be merged into it.

## Usage

```bash
./merge_neighbor_data.py info.json info_neighbors.json output.json
```

### Arguments

1. `info.json` - Input file with node information (from export_nodes_from_db.py)
2. `info_neighbors.json` - Input file with neighbor data (from export_neighbors_from_db.py)
3. `output.json` - Output file with merged data

### Example

```bash
cd /home/dietpi/bot/map

# Generate node info
./export_nodes_from_db.py ../node_names.json ../traffic_history.db 48 > info_temp.json

# Generate neighbor info
./export_neighbors_from_db.py ../traffic_history.db 48 > info_neighbors.json

# Merge both
./merge_neighbor_data.py info_temp.json info_neighbors.json info.json
```

## Input Formats

### info.json (from export_nodes_from_db.py)
```json
{
  "Nodes in mesh": {
    "!16fa4fdc": {
      "num": 385503196,
      "user": {...},
      "hopsAway": 0
    }
  }
}
```

### info_neighbors.json (from export_neighbors_from_db.py)
```json
{
  "nodes": {
    "!16fa4fdc": {
      "neighbors_extracted": [
        {
          "node_id": "!075bcd15",
          "snr": 8.5
        }
      ]
    }
  }
}
```

## Output Format

```json
{
  "Nodes in mesh": {
    "!16fa4fdc": {
      "num": 385503196,
      "user": {...},
      "hopsAway": 0,
      "neighbors": [
        {
          "nodeId": "!075bcd15",
          "snr": 8.5
        }
      ]
    }
  }
}
```

## Integration with infoup_db.sh

The script is automatically called by `infoup_db.sh`:

```bash
# Export nodes
export_nodes_from_db.py ... > /tmp/info_temp.json

# Export neighbors
export_neighbors_from_db.py ... > info_neighbors.json

# Merge both
merge_neighbor_data.py /tmp/info_temp.json info_neighbors.json info.json
```

## Error Handling

- If `info_neighbors.json` is missing: continues with just node data (no links on map)
- If JSON is malformed: logs warning and continues
- If merge fails: returns non-zero exit code

## Validation

After merging, validate the output:

```bash
./validate_info_json.py info.json
```

Should show:
- ✅ Nodes with hopsAway (for coloring)
- ✅ Nodes with neighbors (for links)

## See Also

- `export_nodes_from_db.py` - Generates node information
- `export_neighbors_from_db.py` - Generates neighbor relationships
- `validate_info_json.py` - Validates merged output
- `infoup_db.sh` - Main update script that uses this merge
