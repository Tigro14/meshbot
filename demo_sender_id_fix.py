#!/usr/bin/env python3
"""
Visual demonstration of the sender_id None fix
Shows before/after behavior with the exact event from the logs
"""

def show_before():
    """Show the problematic behavior before the fix"""
    print("\n" + "="*70)
    print("BEFORE FIX - Crash with TypeError")
    print("="*70 + "\n")
    
    print("Event received:")
    print("  type: CONTACT_MSG_RECV")
    print("  payload: {")
    print("    'type': 'PRIV',")
    print("    'SNR': 12.5,")
    print("    'pubkey_prefix': '143bcd7f1b1f',  # âš ï¸  Only this, no sender_id!")
    print("    'path_len': 255,")
    print("    'txt_type': 0,")
    print("    'sender_timestamp': 1768922280,")
    print("    'text': '/help'")
    print("  }")
    print()
    
    print("Code execution:")
    print("  sender_id = payload.get('contact_id') or payload.get('sender_id')")
    print("  # sender_id = None (not found in payload)")
    print()
    print("  info_print(f\"De: 0x{sender_id:08x} | Message: {text}\")")
    print("           " + " "*13 + "^" * 15)
    print("           " + " "*13 + "âŒ CRASH HERE!")
    print()
    
    print("Error:")
    print("  âŒ TypeError: unsupported format string passed to NoneType.__format__")
    print("  ğŸ“› Bot stops processing the message")
    print("  ğŸ“› User receives no response")
    print()

def show_after():
    """Show the fixed behavior after the fix"""
    print("\n" + "="*70)
    print("AFTER FIX - Graceful Handling âœ…")
    print("="*70 + "\n")
    
    print("Event received:")
    print("  type: CONTACT_MSG_RECV")
    print("  payload: {")
    print("    'type': 'PRIV',")
    print("    'SNR': 12.5,")
    print("    'pubkey_prefix': '143bcd7f1b1f',  # âœ… Will be used as fallback")
    print("    'path_len': 255,")
    print("    'txt_type': 0,")
    print("    'sender_timestamp': 1768922280,")
    print("    'text': '/help'")
    print("  }")
    print()
    
    print("Code execution:")
    print("  # Try multiple sources")
    print("  sender_id = None")
    print("  sender_id = payload.get('contact_id') or payload.get('sender_id')")
    print("  # sender_id = None")
    print()
    print("  if sender_id is None and hasattr(event, 'attributes'):")
    print("      sender_id = attributes.get('contact_id') or attributes.get('sender_id')")
    print("  # sender_id = None")
    print()
    print("  if sender_id is None and hasattr(event, 'contact_id'):")
    print("      sender_id = event.contact_id")
    print("  # sender_id = None")
    print()
    
    print("Safe formatting:")
    print("  if sender_id is not None:")
    print("      info_print(f\"De: 0x{sender_id:08x} | Message: {text}\")")
    print("  else:")
    print("      pubkey_prefix = payload.get('pubkey_prefix')")
    print("      if pubkey_prefix:")
    print("          info_print(f\"De: {pubkey_prefix} | Message: {text}\")")
    print("                         ^" * 14)
    print("                         âœ… Fallback to pubkey_prefix")
    print()
    
    print("Output:")
    print("  âœ… [INFO] ğŸ“¬ [MESHCORE-DM] De: 143bcd7f1b1f | Message: /help")
    print("  âœ… Packet created with from: 0xFFFFFFFF (default)")
    print("  âœ… Bot processes the message successfully")
    print("  âœ… User receives a response")
    print()

def show_comparison():
    """Show side-by-side comparison"""
    print("\n" + "="*70)
    print("COMPARISON")
    print("="*70 + "\n")
    
    print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚          BEFORE (Bad)           â”‚          AFTER (Good)           â”‚")
    print("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
    print("â”‚ sender_id = payload.get(...)    â”‚ sender_id = None                â”‚")
    print("â”‚ # sender_id = None              â”‚                                 â”‚")
    print("â”‚                                 â”‚ # Try multiple sources          â”‚")
    print("â”‚                                 â”‚ if isinstance(payload, dict):   â”‚")
    print("â”‚                                 â”‚     sender_id = payload.get...  â”‚")
    print("â”‚                                 â”‚                                 â”‚")
    print("â”‚                                 â”‚ if sender_id is None:           â”‚")
    print("â”‚                                 â”‚     sender_id = attributes.get..â”‚")
    print("â”‚                                 â”‚                                 â”‚")
    print("â”‚                                 â”‚ if sender_id is None:           â”‚")
    print("â”‚                                 â”‚     sender_id = event.contact_idâ”‚")
    print("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
    print("â”‚ f\"0x{sender_id:08x}\"            â”‚ if sender_id is not None:       â”‚")
    print("â”‚        â†“                        â”‚     f\"0x{sender_id:08x}\"         â”‚")
    print("â”‚ âŒ TypeError!                    â”‚ else:                           â”‚")
    print("â”‚ âŒ Crash!                        â”‚     pubkey = payload.get(...)   â”‚")
    print("â”‚                                 â”‚     if pubkey:                  â”‚")
    print("â”‚                                 â”‚         f\"{pubkey}\"              â”‚")
    print("â”‚                                 â”‚     âœ… No crash!                 â”‚")
    print("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤")
    print("â”‚ 'from': sender_id               â”‚ 'from': sender_id if ... else   â”‚")
    print("â”‚         â†“                       â”‚         0xFFFFFFFF              â”‚")
    print("â”‚ 'from': None                    â”‚ 'from': 0xFFFFFFFF              â”‚")
    print("â”‚ âŒ Invalid packet                â”‚ âœ… Valid packet                  â”‚")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
    print()

def main():
    """Main demo"""
    print("\n" + "ğŸ”§"*35)
    print("VISUAL DEMONSTRATION: sender_id None Fix")
    print("ğŸ”§"*35)
    
    show_before()
    show_after()
    show_comparison()
    
    print("\n" + "="*70)
    print("SUMMARY")
    print("="*70 + "\n")
    print("The fix implements THREE key improvements:")
    print()
    print("1. ğŸ” MULTI-SOURCE EXTRACTION")
    print("   Try payload â†’ attributes â†’ event object")
    print()
    print("2. âœ… SAFE FORMATTING")
    print("   Check if sender_id is None before using :08x format")
    print()
    print("3. ğŸ”„ GRACEFUL FALLBACK")
    print("   Use pubkey_prefix when sender_id not available")
    print("   Use 0xFFFFFFFF as default packet value")
    print()
    print("Result: No more TypeError crashes! ğŸ‰")
    print()

if __name__ == "__main__":
    main()
