================================================================================
SOURCE-DEBUG VISIBILITY FIX - DEPLOYMENT GUIDE
================================================================================

PROBLEM: journalctl | grep "SOURCE-DEBUG" shows nothing after git pull/restart

ROOT CAUSE: SOURCE-DEBUG logs only appear WHEN PACKETS ARE RECEIVED
            Without packets â†’ no logs â†’ can't verify deployment

SOLUTION: Added startup and periodic status logging

================================================================================
WHAT WAS ADDED
================================================================================

1. STARTUP BANNER (appears immediately)
   âœ… Confirms code deployed
   âœ… Shows git commit
   âœ… Shows DEBUG_MODE status
   âœ… Appears even with zero packets

2. STATUS LOGGING (every 2 minutes)
   âœ… Shows bot is alive
   âœ… Shows packet count
   âœ… Warns if no packets (explains missing SOURCE-DEBUG)
   âœ… Confirms packets flowing

================================================================================
VERIFICATION AFTER DEPLOYMENT
================================================================================

STEP 1: Check Startup (Immediate)
----------------------------------
journalctl -u meshbot -n 100 | grep "MESHBOT STARTUP"

EXPECTED:
  [INFO] ðŸš€ MESHBOT STARTUP - SOURCE-DEBUG DIAGNOSTICS ENABLED
  [INFO] ðŸ“… Startup time: 2026-02-08 19:15:30
  [INFO] ðŸ“¦ Git commit: 9a8f3b0
  [INFO] ðŸ” DEBUG_MODE: ENABLED âœ…
  [DEBUG] ðŸ” [SOURCE-DEBUG] Diagnostic logging initialized

âœ… If you see this â†’ New code deployed successfully
âŒ If nothing â†’ Bot not running or git pull failed

STEP 2: Check Status (Wait 2 Minutes)
--------------------------------------
journalctl -u meshbot -f | grep "BOT STATUS"

WAIT 2 MINUTES, then you'll see one of:

A) NO PACKETS:
  [INFO] ðŸ“Š BOT STATUS - Uptime: 2m 15s
  [INFO] ðŸ“¦ Packets this session: 0
  [INFO] âš ï¸  WARNING: No packets received yet!
  [INFO]    â†’ SOURCE-DEBUG logs will only appear when packets arrive
  
  â„¹ï¸  This explains why SOURCE-DEBUG logs don't appear
  â„¹ï¸  Check Meshtastic connection

B) PACKETS FLOWING:
  [INFO] ðŸ“Š BOT STATUS - Uptime: 4m 30s
  [INFO] ðŸ“¦ Packets this session: 42
  [INFO] âœ… Packets flowing normally (42 total)
  
  â„¹ï¸  SOURCE-DEBUG logs should be appearing
  â„¹ï¸  Check with: journalctl -u meshbot -n 1000 | grep "SOURCE-DEBUG"

STEP 3: Check SOURCE-DEBUG (If Packets Flowing)
------------------------------------------------
journalctl -u meshbot -f | grep "SOURCE-DEBUG"

EXPECTED when packets arrive:
  [DEBUG] ðŸ” [SOURCE-DEBUG] Determining packet source:
  [DEBUG]    _dual_mode_active=False
  [DEBUG]    network_source=None
  [DEBUG] ðŸ” [SOURCE-DEBUG] Final source = 'local'

================================================================================
TROUBLESHOOTING
================================================================================

ISSUE 1: No Startup Banner
---------------------------
CAUSE: Bot not running or old code
FIX:
  sudo systemctl status meshbot
  cd /home/dietpi/bot && git log --oneline -5
  git pull
  sudo systemctl restart meshbot

ISSUE 2: "No packets received" in Status
-----------------------------------------
CAUSE: Meshtastic not receiving packets
FIX:
  # Check serial connection
  ls -la /dev/ttyUSB* /dev/ttyACM*
  
  # Check config
  grep -E "SERIAL_PORT|REMOTE_NODE" config.py
  
  # Check connection logs
  journalctl -u meshbot -n 200 | grep -i "connect\|device"

ISSUE 3: Packets Flowing but No SOURCE-DEBUG
---------------------------------------------
CAUSE: DEBUG_MODE disabled (very rare)
FIX:
  grep DEBUG_MODE config.py  # Should be True
  
  # If False, edit config.py:
  DEBUG_MODE = True
  sudo systemctl restart meshbot

================================================================================
QUICK DIAGNOSTIC SEQUENCE
================================================================================

# 1. Verify deployment
journalctl -u meshbot -n 100 | grep "MESHBOT STARTUP"
â†’ Should see startup banner immediately

# 2. Wait 2 minutes, check status
journalctl -u meshbot -f | grep "BOT STATUS"
â†’ Shows packet count and explains SOURCE-DEBUG status

# 3. If packets=0, investigate connection
# 4. If packets>0, verify SOURCE-DEBUG logs
journalctl -u meshbot -n 1000 | grep "SOURCE-DEBUG"
â†’ Should see source determination logs

================================================================================
FILES MODIFIED
================================================================================

main_bot.py:
  - __init__ method: +37 lines (startup banner)
  - main loop: +22 lines (periodic status)

New files:
  - test_startup_diagnostics.py (test suite)
  - FIX_SOURCE_DEBUG_VISIBILITY.md (full docs)
  - QUICK_FIX_SOURCE_DEBUG_VISIBILITY.md (quick ref)

================================================================================
SUMMARY
================================================================================

BEFORE: SOURCE-DEBUG invisible without packets
AFTER:  Can verify deployment and diagnose issues immediately

USER CAN NOW:
  âœ… Confirm code deployed (startup banner)
  âœ… Confirm bot running (status every 2 min)
  âœ… See if packets arriving (packet counter)
  âœ… Understand why SOURCE-DEBUG missing (warnings)

DEPLOYMENT RISK: NONE (only added logging)
TESTING: All tests pass âœ…
STATUS: READY FOR PRODUCTION

================================================================================
